(()=>{"use strict";var e={n:a=>{var t=a&&a.__esModule?()=>a.default:()=>a;return e.d(t,{a:t}),t},d:(a,t)=>{for(var n in t)e.o(t,n)&&!e.o(a,n)&&Object.defineProperty(a,n,{enumerable:!0,get:t[n]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.wp.element,t=window.wp.i18n,n=window.wp.apiFetch;var s=e.n(n);const l=window.wp.components,o=window.ReactJSXRuntime;function i({currentEngine:e,targetEngine:a,onTargetEngineChange:n,connectionParams:s,onConnectionParamsChange:i}){const r=[{label:(0,t.__)("MySQL","wp-dbal"),value:"mysql"},{label:(0,t.__)("PostgreSQL","wp-dbal"),value:"pgsql"},{label:(0,t.__)("SQLite","wp-dbal"),value:"sqlite"},{label:(0,t.__)("FileDB","wp-dbal"),value:"filedb"},{label:(0,t.__)("Cloudflare D1","wp-dbal"),value:"d1"}].filter(a=>a.value!==e),c=(e,a)=>{i({...s,[e]:a})};return(0,o.jsxs)("div",{className:"wp-dbal-database-selector",children:[(0,o.jsx)(l.SelectControl,{label:(0,t.__)("Target Database Engine","wp-dbal"),value:a,options:[{label:(0,t.__)("Select target engine...","wp-dbal"),value:""},...r],onChange:n}),"sqlite"===a&&(0,o.jsx)(l.TextControl,{label:(0,t.__)("SQLite Database Path","wp-dbal"),value:s.path||"",onChange:e=>c("path",e),help:(0,t.__)("Path to SQLite database file (relative to WordPress root)","wp-dbal")}),"filedb"===a&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.TextControl,{label:(0,t.__)("FileDB Storage Path","wp-dbal"),value:s.path||"",onChange:e=>c("path",e),help:(0,t.__)("Path to FileDB storage directory (relative to WordPress root)","wp-dbal")}),(0,o.jsx)(l.SelectControl,{label:(0,t.__)("FileDB Format","wp-dbal"),value:s.format||"json",options:[{label:(0,t.__)("JSON","wp-dbal"),value:"json"},{label:(0,t.__)("PHP","wp-dbal"),value:"php"}],onChange:e=>c("format",e)})]}),"d1"===a&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.TextControl,{label:(0,t.__)("D1 Account ID","wp-dbal"),value:s.account_id||"",onChange:e=>c("account_id",e)}),(0,o.jsx)(l.TextControl,{label:(0,t.__)("D1 Database ID","wp-dbal"),value:s.database_id||"",onChange:e=>c("database_id",e)}),(0,o.jsx)(l.TextControl,{label:(0,t.__)("D1 API Token","wp-dbal"),value:s.api_token||"",onChange:e=>c("api_token",e),type:"password"})]}),("mysql"===a||"pgsql"===a)&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.TextControl,{label:(0,t.__)("Host","wp-dbal"),value:s.host||"localhost",onChange:e=>c("host",e)}),(0,o.jsx)(l.TextControl,{label:(0,t.__)("Port","wp-dbal"),value:s.port||("pgsql"===a?"5432":"3306"),onChange:e=>c("port",parseInt(e,10)),type:"number"}),(0,o.jsx)(l.TextControl,{label:(0,t.__)("Database Name","wp-dbal"),value:s.dbname||"",onChange:e=>c("dbname",e)}),(0,o.jsx)(l.TextControl,{label:(0,t.__)("Username","wp-dbal"),value:s.user||"",onChange:e=>c("user",e)}),(0,o.jsx)(l.TextControl,{label:(0,t.__)("Password","wp-dbal"),value:s.password||"",onChange:e=>c("password",e),type:"password"})]})]})}function r({isValidating:e,validationResult:a,onValidate:n}){return a||e?(0,o.jsxs)("div",{className:"wp-dbal-connection-validator",children:[e&&(0,o.jsxs)("div",{children:[(0,o.jsx)(l.Spinner,{}),(0,o.jsx)("span",{children:(0,t.__)("Validating connection...","wp-dbal")})]}),a&&!e&&(0,o.jsx)(l.Notice,{status:a.success?"success":"error",isDismissible:!1,children:a.message})]}):(0,o.jsx)("div",{className:"wp-dbal-connection-validator",children:(0,o.jsx)(l.Button,{variant:"secondary",onClick:n,disabled:e,children:(0,t.__)("Validate Connection","wp-dbal")})})}function c({progress:e}){if(!e)return null;const a=(()=>{if("completed"===e.status)return 100;if("failed"===e.status)return 0;let a=0;const t={schema_export:10,schema_import:10,data_export:40,data_import:40},n=["schema_export","schema_import","data_export","data_import"],s=n.indexOf(e.step);for(let e=0;e<s;e++)a+=t[n[e]]||0;return s>=0&&t[e.step]&&(a+=e.tables_total>0?e.tables_completed/e.tables_total*t[e.step]:0),Math.min(100,Math.max(0,a))})();return(0,o.jsxs)("div",{className:"wp-dbal-migration-progress",children:[(0,o.jsx)("h3",{children:(n=e.step,{schema_export:(0,t.__)("Exporting schemas...","wp-dbal"),schema_import:(0,t.__)("Importing schemas...","wp-dbal"),data_export:(0,t.__)("Exporting data...","wp-dbal"),data_import:(0,t.__)("Importing data...","wp-dbal"),finalize:(0,t.__)("Finalizing migration...","wp-dbal"),completed:(0,t.__)("Migration completed!","wp-dbal")}[n]||n)}),"failed"===e.status&&(0,o.jsx)(l.Notice,{status:"error",isDismissible:!1,children:e.error||(0,t.__)("Migration failed","wp-dbal")}),"completed"===e.status&&(0,o.jsx)(l.Notice,{status:"success",isDismissible:!1,children:(0,t.__)("Migration completed successfully!","wp-dbal")}),"running"===e.status&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(l.ProgressBar,{value:a}),(0,o.jsxs)("p",{children:[e.current_table&&(0,o.jsxs)("span",{children:[(0,t.__)("Current table:","wp-dbal")," ",(0,o.jsx)("strong",{children:e.current_table}),(0,o.jsx)("br",{})]}),e.tables_total>0&&(0,o.jsxs)("span",{children:[(0,t.__)("Tables:","wp-dbal")," ",e.tables_completed," / ",e.tables_total]})]})]})]});var n}function d({isMigrating:e,canStart:a,onStart:n,onCancel:s,progress:i}){return"completed"===i?.status?null:(0,o.jsx)("div",{className:"wp-dbal-migration-controls",children:(0,o.jsxs)(l.ButtonGroup,{children:[(0,o.jsx)(l.Button,{variant:"primary",onClick:n,disabled:!a||e,children:e?(0,t.__)("Migrating...","wp-dbal"):(0,t.__)("Start Migration","wp-dbal")}),e&&(0,o.jsx)(l.Button,{variant:"secondary",onClick:s,children:(0,t.__)("Cancel","wp-dbal")})]})})}function p({targetEngine:e,connectionParams:n,onComplete:i}){const[r,c]=(0,a.useState)(null),[d,p]=(0,a.useState)(!1),[u,g]=(0,a.useState)(null);return"manual"===r?null:(0,o.jsxs)("div",{className:"wp-dbal-config-update-prompt",style:{marginTop:"20px"},children:[(0,o.jsxs)(l.Notice,{status:"success",isDismissible:!1,children:[(0,o.jsx)("p",{children:(0,o.jsx)("strong",{children:(0,t.__)("Migration completed successfully!","wp-dbal")})}),(0,o.jsx)("p",{children:(0,t.__)("Would you like us to automatically update your wp-config.php file, or would you prefer to update it manually?","wp-dbal")})]}),u&&(0,o.jsx)(l.Notice,{status:"error",isDismissible:!1,style:{marginTop:"10px"},children:u}),(0,o.jsxs)(l.ButtonGroup,{style:{marginTop:"15px"},children:[(0,o.jsx)(l.Button,{variant:"primary",onClick:async()=>{p(!0),g(null);try{const a=await s()({path:"/wp-dbal/v1/migration/update-config",method:"POST",data:{target_engine:e,connection_params:n}});a.success?window.location.reload():(g(a.message||(0,t.__)("Failed to update wp-config.php","wp-dbal")),p(!1))}catch(e){g(e.message||(0,t.__)("Failed to update wp-config.php","wp-dbal")),p(!1)}},isBusy:d,disabled:d,children:(0,t.__)("Update Automatically","wp-dbal")}),(0,o.jsx)(l.Button,{variant:"secondary",onClick:()=>{c("manual"),i("manual")},disabled:d,children:(0,t.__)("I'll Update Manually","wp-dbal")})]})]})}function u({currentEngine:e,onConfigChoice:n}){const[l,u]=(0,a.useState)(e||null),[g,_]=(0,a.useState)(""),[m,b]=(0,a.useState)({}),[w,h]=(0,a.useState)(!1),[x,f]=(0,a.useState)(null),[j,v]=(0,a.useState)(null),[y,C]=(0,a.useState)(null),[S,P]=(0,a.useState)(!1),[D,T]=(0,a.useState)(null),[E,F]=(0,a.useState)(null),[M,N]=(0,a.useState)(null);(0,a.useEffect)(()=>{e||B()},[e]),(0,a.useEffect)(()=>{g?(async()=>{try{const e=await s()({path:`/wp-dbal/v1/admin/configuration?db_engine=${g}`});e.success&&e.data?.connection_params&&b(e.data.connection_params)}catch(e){console.error("Failed to fetch connection params:",e)}})():b({})},[g]),(0,a.useEffect)(()=>{if(!j||!S)return;const e=setInterval(()=>{k()},1e3);return()=>clearInterval(e)},[j,S]);const B=async()=>{try{const e=await s()({path:"/wp-dbal/v1/migration/status"});e.success&&u(e.current_engine)}catch(e){console.error("Failed to fetch current engine:",e)}},k=async()=>{if(j)try{const e=await s()({path:`/wp-dbal/v1/migration/progress?session_id=${j}`});e.success&&(C(e.progress),"completed"!==e.progress.status&&"failed"!==e.progress.status||P(!1))}catch(e){console.error("Failed to fetch progress:",e)}};return(0,o.jsxs)("div",{className:"wp-dbal-migration-ui",children:[l&&(0,o.jsxs)("p",{children:[(0,t.__)("Current database engine:","wp-dbal")," ",(0,o.jsx)("strong",{children:l})]}),D&&(0,o.jsx)("div",{className:"notice notice-error",children:(0,o.jsx)("p",{children:D})}),!S&&!y&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(i,{currentEngine:l,targetEngine:g,onTargetEngineChange:_,connectionParams:m,onConnectionParamsChange:b}),(0,o.jsx)(r,{isValidating:w,validationResult:x,onValidate:async()=>{if(g){h(!0),T(null),f(null);try{const e=await s()({path:"/wp-dbal/v1/migration/validate",method:"POST",data:{target_engine:g,connection_params:m}});e.success?f({success:!0,message:e.message}):f({success:!1,message:e.message||(0,t.__)("Validation failed","wp-dbal")})}catch(e){f({success:!1,message:e.message||(0,t.__)("Validation failed","wp-dbal")})}finally{h(!1)}}else T((0,t.__)("Please select a target database engine","wp-dbal"))}})]}),y&&(0,o.jsx)(c,{progress:y}),"completed"===y?.status&&!E&&M&&(0,o.jsx)(p,{targetEngine:M.targetEngine,connectionParams:M.connectionParams,onComplete:e=>{F(e),"manual"===e&&n&&n(e,M)}}),"completed"!==y?.status&&(0,o.jsx)(d,{isMigrating:S,canStart:!!g&&x?.success,onStart:async()=>{if(g)if(x&&x.success){T(null),P(!0),F(null),N({targetEngine:g,connectionParams:m});try{const e=await s()({path:"/wp-dbal/v1/migration/start",method:"POST",data:{target_engine:g,connection_params:m}});e.success?(v(e.session_id),(async e=>{let a=!1,n=0;for(;!a&&n<1e4;){n++;try{const n=await s()({path:"/wp-dbal/v1/migration/chunk",method:"POST",data:{session_id:e}});if(!n.success){T(n.message||(0,t.__)("Chunk processing failed","wp-dbal")),P(!1),a=!0;break}if(C(n.progress),a=n.complete,a){P(!1),"failed"===n.progress.status&&T(n.progress.error||(0,t.__)("Migration failed","wp-dbal"));break}await new Promise(e=>setTimeout(e,100))}catch(e){T(e.message||(0,t.__)("Chunk processing failed","wp-dbal")),P(!1),a=!0;break}}n>=1e4&&(T((0,t.__)("Migration timeout - maximum iterations exceeded","wp-dbal")),P(!1))})(e.session_id)):(T(e.message||(0,t.__)("Failed to start migration","wp-dbal")),P(!1))}catch(e){T(e.message||(0,t.__)("Failed to start migration","wp-dbal")),P(!1)}}else T((0,t.__)("Please validate the connection first","wp-dbal"));else T((0,t.__)("Please select a target database engine","wp-dbal"))},onCancel:async()=>{if(j)try{await s()({path:"/wp-dbal/v1/migration/cancel",method:"POST",data:{session_id:j}}),P(!1),v(null),C(null)}catch(e){console.error("Failed to cancel migration:",e)}},progress:y})]})}function g(){const e=document.getElementById("wp-dbal-migration-root");if(e)try{(0,a.render)((0,o.jsx)(u,{}),e),console.log("WP-DBAL: Migration UI rendered successfully")}catch(e){console.error("WP-DBAL: Error rendering migration UI",e)}else console.warn("WP-DBAL: Migration container not found. Looking for #wp-dbal-migration-root")}"undefined"!=typeof window&&window.wpDbalAdmin?.restNonce&&s().use(s().createNonceMiddleware(window.wpDbalAdmin.restNonce)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g):g()})();