(()=>{"use strict";var e={n:a=>{var n=a&&a.__esModule?()=>a.default:()=>a;return e.d(n,{a:n}),n},d:(a,n)=>{for(var t in n)e.o(n,t)&&!e.o(a,t)&&Object.defineProperty(a,t,{enumerable:!0,get:n[t]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.wp.element,n=window.wp.components,t=window.wp.i18n,s=window.wp.apiFetch;var l=e.n(s);const r=window.ReactJSXRuntime;function o({status:e}){return(0,r.jsxs)(n.Card,{children:[(0,r.jsx)(n.CardHeader,{children:(0,r.jsx)("h2",{children:(0,t.__)("Status","wp-dbal")})}),(0,r.jsx)(n.CardBody,{children:(0,r.jsx)("table",{className:"form-table",children:(0,r.jsxs)("tbody",{children:[(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Drop-in Status","wp-dbal")}),(0,r.jsx)("td",{children:e.dropin_installed?(0,r.jsxs)("span",{style:{color:"green"},children:["✓ ",(0,t.__)("Installed","wp-dbal")]}):(0,r.jsxs)("span",{style:{color:"red"},children:["✗ ",(0,t.__)("Not Installed","wp-dbal")]})})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database Engine","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.db_engine})})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("DBAL Version","wp-dbal")}),(0,r.jsx)("td",{children:e.dbal_loaded?(0,r.jsx)("code",{children:e.dbal_version||(0,t.__)("Loaded","wp-dbal")}):(0,r.jsx)("span",{children:(0,t.__)("Not loaded (run composer install)","wp-dbal")})})]})]})})})]})}function i({dropinInstalled:e,onAction:s}){const[l,o]=(0,a.useState)(!1),i=async e=>{o(!0),await s(e),o(!1)};return(0,r.jsx)(n.Card,{style:{marginTop:"20px"},children:(0,r.jsxs)(n.CardBody,{children:[(0,r.jsx)("h3",{children:(0,t.__)("Drop-in Management","wp-dbal")}),(0,r.jsx)("p",{children:(0,t.__)("The db.php drop-in is required for WP-DBAL to function. It intercepts WordPress database calls and routes them through Doctrine DBAL.","wp-dbal")}),e?(0,r.jsx)(n.Button,{variant:"secondary",onClick:()=>i("remove"),isBusy:l,disabled:l,children:(0,t.__)("Remove Drop-in","wp-dbal")}):(0,r.jsx)(n.Button,{variant:"primary",onClick:()=>i("install"),isBusy:l,disabled:l,children:(0,t.__)("Install Drop-in","wp-dbal")})]})})}function d(){const[e,s]=(0,a.useState)(null),[o,i]=(0,a.useState)(!0),[d,c]=(0,a.useState)(!1),[p,_]=(0,a.useState)(!1),[h,u]=(0,a.useState)(null),[b,x]=(0,a.useState)(null),[g,m]=(0,a.useState)("mysql"),[w,j]=(0,a.useState)({});(0,a.useEffect)(()=>{f()},[]);const f=async()=>{i(!0),u(null);try{const e=await l()({path:"/wp-dbal/v1/admin/configuration"});e.success?(s(e.data),m(e.data.db_engine||"mysql"),j(e.data.connection_params||{})):u((0,t.__)("Failed to fetch configuration","wp-dbal"))}catch(e){u(e.message||(0,t.__)("Failed to fetch configuration","wp-dbal"))}finally{i(!1)}},C=(e,a)=>{j(n=>({...n,[e]:a}))};if(o)return(0,r.jsxs)(n.Card,{children:[(0,r.jsx)(n.CardHeader,{children:(0,r.jsx)("h2",{children:(0,t.__)("Current Configuration","wp-dbal")})}),(0,r.jsx)(n.CardBody,{children:(0,r.jsx)("p",{children:(0,t.__)("Loading...","wp-dbal")})})]});if(!e)return null;const v=[{label:(0,t.__)("MySQL","wp-dbal"),value:"mysql"},{label:(0,t.__)("PostgreSQL","wp-dbal"),value:"pgsql"},{label:(0,t.__)("SQLite","wp-dbal"),value:"sqlite"},{label:(0,t.__)("FileDB","wp-dbal"),value:"filedb"},{label:(0,t.__)("Cloudflare D1","wp-dbal"),value:"d1"}];return(0,r.jsxs)(n.Card,{children:[(0,r.jsx)(n.CardHeader,{children:(0,r.jsx)("h2",{children:(0,t.__)("Current Configuration","wp-dbal")})}),(0,r.jsxs)(n.CardBody,{children:[h&&(0,r.jsx)(n.Notice,{status:"error",onRemove:()=>u(null),children:h}),b&&(0,r.jsx)(n.Notice,{status:"success",isDismissible:!1,children:b}),d?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.SelectControl,{label:(0,t.__)("Database Engine","wp-dbal"),value:g,options:v,onChange:m}),"mysql"===g&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database Name","wp-dbal"),value:w.dbname||"",onChange:e=>C("dbname",e),help:(0,t.__)("The name of the database for WordPress.","wp-dbal")}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database User","wp-dbal"),value:w.user||"",onChange:e=>C("user",e),help:(0,t.__)("Database username.","wp-dbal")}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database Password","wp-dbal"),value:w.password||"",onChange:e=>C("password",e),type:"password",help:(0,t.__)("Database password.","wp-dbal")}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database Host","wp-dbal"),value:w.host||"localhost",onChange:e=>C("host",e),help:(0,t.__)("Database hostname.","wp-dbal")}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database Charset","wp-dbal"),value:w.charset||"utf8",onChange:e=>C("charset",e),help:(0,t.__)("Database charset to use in creating database tables.","wp-dbal")}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database Collate","wp-dbal"),value:w.collate||"",onChange:e=>C("collate",e),help:(0,t.__)("The database collate type. Leave empty if in doubt.","wp-dbal")})]}),"sqlite"===g&&(0,r.jsx)(n.TextControl,{label:(0,t.__)("SQLite Database Path","wp-dbal"),value:w.path||"",onChange:e=>C("path",e),help:(0,t.__)("Path to the SQLite database file (e.g., wp-content/database/.ht.sqlite).","wp-dbal")}),"filedb"===g&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("FileDB Storage Path","wp-dbal"),value:w.path||"",onChange:e=>C("path",e),help:(0,t.__)("Path to the directory where FileDB will store data (e.g., wp-content/file-db).","wp-dbal")}),(0,r.jsx)(n.SelectControl,{label:(0,t.__)("FileDB Format","wp-dbal"),value:w.format||"json",options:[{label:"JSON",value:"json"},{label:"PHP (serialized)",value:"php"}],onChange:e=>C("format",e)})]}),"d1"===g&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("Cloudflare Account ID","wp-dbal"),value:w.account_id||"",onChange:e=>C("account_id",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Cloudflare D1 Database ID","wp-dbal"),value:w.database_id||"",onChange:e=>C("database_id",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Cloudflare API Token","wp-dbal"),value:w.api_token||"",onChange:e=>C("api_token",e),type:"password"})]}),("pgsql"===g||"postgresql"===g)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("PostgreSQL Host","wp-dbal"),value:w.host||"",onChange:e=>C("host",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("PostgreSQL Port","wp-dbal"),value:w.port||"",onChange:e=>C("port",e),type:"number"}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("PostgreSQL Database Name","wp-dbal"),value:w.dbname||"",onChange:e=>C("dbname",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("PostgreSQL User","wp-dbal"),value:w.user||"",onChange:e=>C("user",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("PostgreSQL Password","wp-dbal"),value:w.password||"",onChange:e=>C("password",e),type:"password"})]}),(0,r.jsxs)("div",{style:{marginTop:"20px"},children:[(0,r.jsx)(n.Button,{variant:"primary",onClick:async()=>{_(!0),u(null),x(null);try{const e=await l()({path:"/wp-dbal/v1/admin/configuration",method:"POST",data:{db_engine:g,connection_params:w}});e.success?(x((0,t.__)("Configuration updated successfully. The page will reload.","wp-dbal")),c(!1),setTimeout(()=>{window.location.reload()},1500)):u(e.message||(0,t.__)("Failed to update configuration","wp-dbal"))}catch(e){u(e.message||(0,t.__)("Failed to update configuration","wp-dbal"))}finally{_(!1)}},isBusy:p,disabled:p,children:(0,t.__)("Save Configuration","wp-dbal")}),(0,r.jsx)(n.Button,{variant:"secondary",onClick:()=>{c(!1),u(null),m(e.db_engine||"mysql"),j(e.connection_params||{})},disabled:p,style:{marginLeft:"10px"},children:(0,t.__)("Cancel","wp-dbal")})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("table",{className:"form-table",children:(0,r.jsxs)("tbody",{children:[(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database Engine","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.db_engine||"mysql"})})]}),"mysql"===e.db_engine&&(0,r.jsxs)(r.Fragment,{children:[e.connection_params?.dbname&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database Name","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.dbname})})]}),e.connection_params?.user&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database User","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.user})})]}),e.connection_params?.host&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database Host","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.host})})]}),e.connection_params?.charset&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database Charset","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.charset})})]}),e.connection_params?.collate&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("Database Collate","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.collate})})]})]}),"sqlite"===e.db_engine&&e.connection_params?.path&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("SQLite Path","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.path})})]}),"filedb"===e.db_engine&&(0,r.jsxs)(r.Fragment,{children:[e.connection_params?.path&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("FileDB Path","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.path})})]}),e.connection_params?.format&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("FileDB Format","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.format})})]})]}),"d1"===e.db_engine&&(0,r.jsxs)(r.Fragment,{children:[e.connection_params?.account_id&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("D1 Account ID","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.account_id})})]}),e.connection_params?.database_id&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("D1 Database ID","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.database_id})})]})]}),("pgsql"===e.db_engine||"postgresql"===e.db_engine)&&(0,r.jsxs)(r.Fragment,{children:[e.connection_params?.host&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("PostgreSQL Host","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.host})})]}),e.connection_params?.port&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("PostgreSQL Port","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.port})})]}),e.connection_params?.dbname&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("PostgreSQL Database","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.dbname})})]}),e.connection_params?.user&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("PostgreSQL User","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:e.connection_params.user})})]}),e.connection_params?.password&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,t.__)("PostgreSQL Password","wp-dbal")}),(0,r.jsx)("td",{children:(0,r.jsx)("code",{children:"••••••••"})})]})]})]})}),(0,r.jsx)(n.Button,{variant:"secondary",onClick:()=>c(!0),style:{marginTop:"15px"},children:(0,t.__)("Edit Configuration","wp-dbal")})]})]})]})}function c({targetEngine:e,connectionParams:a={}}){return e?(0,r.jsxs)(n.Card,{style:{marginTop:"20px"},children:[(0,r.jsx)(n.CardHeader,{children:(0,r.jsx)("h2",{children:(0,t.__)("Configuration","wp-dbal")})}),(0,r.jsxs)(n.CardBody,{children:[(0,r.jsx)("p",{children:(0,t.__)("Add the following to your wp-config.php file to use the new database:","wp-dbal")}),(0,r.jsx)("pre",{style:{background:"#f0f0f0",padding:"15px",overflowX:"auto",marginTop:"10px",whiteSpace:"pre-wrap"},children:(()=>{let n=`define( 'DB_ENGINE', '${e}' );\n\n`;switch(e){case"sqlite":a.path&&(n+=`define( 'DB_SQLITE_PATH', '${a.path}' );`);break;case"filedb":a.path&&(n+=`define( 'DB_FILEDB_PATH', '${a.path}' );`),a.format&&(n+=`\ndefine( 'DB_FILEDB_FORMAT', '${a.format}' );`);break;case"d1":a.account_id&&(n+=`define( 'DB_D1_ACCOUNT_ID', '${a.account_id}' );`),a.database_id&&(n+=`\ndefine( 'DB_D1_DATABASE_ID', '${a.database_id}' );`),a.api_token&&(n+=`\ndefine( 'DB_D1_API_TOKEN', '${a.api_token}' );`);break;case"pgsql":case"postgresql":n+="// PostgreSQL connection options\n",n+="define( 'DB_DBAL_OPTIONS', [\n",n+="    'driver' => 'pdo_pgsql',\n",a.host&&(n+=`    'host' => '${a.host}',\n`),a.port&&(n+=`    'port' => ${a.port},\n`),a.dbname&&(n+=`    'dbname' => '${a.dbname}',\n`),a.user&&(n+=`    'user' => '${a.user}',\n`),a.password&&(n+=`    'password' => '${a.password}',\n`),n+="] );"}return n})()}),(0,r.jsx)("p",{style:{marginTop:"15px"},children:(0,t.__)("After adding these lines, reload this page to use the new database.","wp-dbal")})]})]}):null}function p({currentEngine:e,targetEngine:a,onTargetEngineChange:s,connectionParams:l,onConnectionParamsChange:o}){const i=[{label:(0,t.__)("MySQL","wp-dbal"),value:"mysql"},{label:(0,t.__)("PostgreSQL","wp-dbal"),value:"pgsql"},{label:(0,t.__)("SQLite","wp-dbal"),value:"sqlite"},{label:(0,t.__)("FileDB","wp-dbal"),value:"filedb"},{label:(0,t.__)("Cloudflare D1","wp-dbal"),value:"d1"}].filter(a=>a.value!==e),d=(e,a)=>{o({...l,[e]:a})};return(0,r.jsxs)("div",{className:"wp-dbal-database-selector",children:[(0,r.jsx)(n.SelectControl,{label:(0,t.__)("Target Database Engine","wp-dbal"),value:a,options:[{label:(0,t.__)("Select target engine...","wp-dbal"),value:""},...i],onChange:s}),"sqlite"===a&&(0,r.jsx)(n.TextControl,{label:(0,t.__)("SQLite Database Path","wp-dbal"),value:l.path||"",onChange:e=>d("path",e),help:(0,t.__)("Path to SQLite database file (relative to WordPress root)","wp-dbal")}),"filedb"===a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("FileDB Storage Path","wp-dbal"),value:l.path||"",onChange:e=>d("path",e),help:(0,t.__)("Path to FileDB storage directory (relative to WordPress root)","wp-dbal")}),(0,r.jsx)(n.SelectControl,{label:(0,t.__)("FileDB Format","wp-dbal"),value:l.format||"json",options:[{label:(0,t.__)("JSON","wp-dbal"),value:"json"},{label:(0,t.__)("PHP","wp-dbal"),value:"php"}],onChange:e=>d("format",e)})]}),"d1"===a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("D1 Account ID","wp-dbal"),value:l.account_id||"",onChange:e=>d("account_id",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("D1 Database ID","wp-dbal"),value:l.database_id||"",onChange:e=>d("database_id",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("D1 API Token","wp-dbal"),value:l.api_token||"",onChange:e=>d("api_token",e),type:"password"})]}),("mysql"===a||"pgsql"===a)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.TextControl,{label:(0,t.__)("Host","wp-dbal"),value:l.host||"localhost",onChange:e=>d("host",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Port","wp-dbal"),value:l.port||("pgsql"===a?"5432":"3306"),onChange:e=>d("port",parseInt(e,10)),type:"number"}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Database Name","wp-dbal"),value:l.dbname||"",onChange:e=>d("dbname",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Username","wp-dbal"),value:l.user||"",onChange:e=>d("user",e)}),(0,r.jsx)(n.TextControl,{label:(0,t.__)("Password","wp-dbal"),value:l.password||"",onChange:e=>d("password",e),type:"password"})]})]})}function _({isValidating:e,validationResult:a,onValidate:s}){return a||e?(0,r.jsxs)("div",{className:"wp-dbal-connection-validator",children:[e&&(0,r.jsxs)("div",{children:[(0,r.jsx)(n.Spinner,{}),(0,r.jsx)("span",{children:(0,t.__)("Validating connection...","wp-dbal")})]}),a&&!e&&(0,r.jsx)(n.Notice,{status:a.success?"success":"error",isDismissible:!1,children:a.message})]}):(0,r.jsx)("div",{className:"wp-dbal-connection-validator",children:(0,r.jsx)(n.Button,{variant:"secondary",onClick:s,disabled:e,children:(0,t.__)("Validate Connection","wp-dbal")})})}function h({progress:e}){if(!e)return null;const a=(()=>{if("completed"===e.status)return 100;if("failed"===e.status)return 0;let a=0;const n={schema_export:10,schema_import:10,data_export:40,data_import:40},t=["schema_export","schema_import","data_export","data_import"],s=t.indexOf(e.step);for(let e=0;e<s;e++)a+=n[t[e]]||0;return s>=0&&n[e.step]&&(a+=e.tables_total>0?e.tables_completed/e.tables_total*n[e.step]:0),Math.min(100,Math.max(0,a))})();return(0,r.jsxs)("div",{className:"wp-dbal-migration-progress",children:[(0,r.jsx)("h3",{children:(s=e.step,{schema_export:(0,t.__)("Exporting schemas...","wp-dbal"),schema_import:(0,t.__)("Importing schemas...","wp-dbal"),data_export:(0,t.__)("Exporting data...","wp-dbal"),data_import:(0,t.__)("Importing data...","wp-dbal"),finalize:(0,t.__)("Finalizing migration...","wp-dbal"),completed:(0,t.__)("Migration completed!","wp-dbal")}[s]||s)}),"failed"===e.status&&(0,r.jsx)(n.Notice,{status:"error",isDismissible:!1,children:e.error||(0,t.__)("Migration failed","wp-dbal")}),"completed"===e.status&&(0,r.jsx)(n.Notice,{status:"success",isDismissible:!1,children:(0,t.__)("Migration completed successfully!","wp-dbal")}),"running"===e.status&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.ProgressBar,{value:a}),(0,r.jsxs)("p",{children:[e.current_table&&(0,r.jsxs)("span",{children:[(0,t.__)("Current table:","wp-dbal")," ",(0,r.jsx)("strong",{children:e.current_table}),(0,r.jsx)("br",{})]}),e.tables_total>0&&(0,r.jsxs)("span",{children:[(0,t.__)("Tables:","wp-dbal")," ",e.tables_completed," / ",e.tables_total]})]})]})]});var s}function u({isMigrating:e,canStart:a,onStart:s,onCancel:l,progress:o}){return"completed"===o?.status?null:(0,r.jsx)("div",{className:"wp-dbal-migration-controls",children:(0,r.jsxs)(n.ButtonGroup,{children:[(0,r.jsx)(n.Button,{variant:"primary",onClick:s,disabled:!a||e,children:e?(0,t.__)("Migrating...","wp-dbal"):(0,t.__)("Start Migration","wp-dbal")}),e&&(0,r.jsx)(n.Button,{variant:"secondary",onClick:l,children:(0,t.__)("Cancel","wp-dbal")})]})})}function b({targetEngine:e,connectionParams:s,onComplete:o}){const[i,d]=(0,a.useState)(null),[c,p]=(0,a.useState)(!1),[_,h]=(0,a.useState)(null);return"manual"===i?null:(0,r.jsxs)("div",{className:"wp-dbal-config-update-prompt",style:{marginTop:"20px"},children:[(0,r.jsxs)(n.Notice,{status:"success",isDismissible:!1,children:[(0,r.jsx)("p",{children:(0,r.jsx)("strong",{children:(0,t.__)("Migration completed successfully!","wp-dbal")})}),(0,r.jsx)("p",{children:(0,t.__)("Would you like us to automatically update your wp-config.php file, or would you prefer to update it manually?","wp-dbal")})]}),_&&(0,r.jsx)(n.Notice,{status:"error",isDismissible:!1,style:{marginTop:"10px"},children:_}),(0,r.jsxs)(n.ButtonGroup,{style:{marginTop:"15px"},children:[(0,r.jsx)(n.Button,{variant:"primary",onClick:async()=>{p(!0),h(null);try{const a=await l()({path:"/wp-dbal/v1/migration/update-config",method:"POST",data:{target_engine:e,connection_params:s}});a.success?window.location.reload():(h(a.message||(0,t.__)("Failed to update wp-config.php","wp-dbal")),p(!1))}catch(e){h(e.message||(0,t.__)("Failed to update wp-config.php","wp-dbal")),p(!1)}},isBusy:c,disabled:c,children:(0,t.__)("Update Automatically","wp-dbal")}),(0,r.jsx)(n.Button,{variant:"secondary",onClick:()=>{d("manual"),o("manual")},disabled:c,children:(0,t.__)("I'll Update Manually","wp-dbal")})]})]})}function x({currentEngine:e,onConfigChoice:n}){const[s,o]=(0,a.useState)(e||null),[i,d]=(0,a.useState)(""),[c,x]=(0,a.useState)({}),[g,m]=(0,a.useState)(!1),[w,j]=(0,a.useState)(null),[f,C]=(0,a.useState)(null),[v,y]=(0,a.useState)(null),[D,S]=(0,a.useState)(!1),[P,T]=(0,a.useState)(null),[B,F]=(0,a.useState)(null),[L,N]=(0,a.useState)(null);(0,a.useEffect)(()=>{e||E()},[e]),(0,a.useEffect)(()=>{i?(async()=>{try{const e=await l()({path:`/wp-dbal/v1/admin/configuration?db_engine=${i}`});e.success&&e.data?.connection_params&&x(e.data.connection_params)}catch(e){console.error("Failed to fetch connection params:",e)}})():x({})},[i]),(0,a.useEffect)(()=>{if(!f||!D)return;const e=setInterval(()=>{A()},1e3);return()=>clearInterval(e)},[f,D]);const E=async()=>{try{const e=await l()({path:"/wp-dbal/v1/migration/status"});e.success&&o(e.current_engine)}catch(e){console.error("Failed to fetch current engine:",e)}},A=async()=>{if(f)try{const e=await l()({path:`/wp-dbal/v1/migration/progress?session_id=${f}`});e.success&&(y(e.progress),"completed"!==e.progress.status&&"failed"!==e.progress.status||S(!1))}catch(e){console.error("Failed to fetch progress:",e)}};return(0,r.jsxs)("div",{className:"wp-dbal-migration-ui",children:[s&&(0,r.jsxs)("p",{children:[(0,t.__)("Current database engine:","wp-dbal")," ",(0,r.jsx)("strong",{children:s})]}),P&&(0,r.jsx)("div",{className:"notice notice-error",children:(0,r.jsx)("p",{children:P})}),!D&&!v&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(p,{currentEngine:s,targetEngine:i,onTargetEngineChange:d,connectionParams:c,onConnectionParamsChange:x}),(0,r.jsx)(_,{isValidating:g,validationResult:w,onValidate:async()=>{if(i){m(!0),T(null),j(null);try{const e=await l()({path:"/wp-dbal/v1/migration/validate",method:"POST",data:{target_engine:i,connection_params:c}});e.success?j({success:!0,message:e.message}):j({success:!1,message:e.message||(0,t.__)("Validation failed","wp-dbal")})}catch(e){j({success:!1,message:e.message||(0,t.__)("Validation failed","wp-dbal")})}finally{m(!1)}}else T((0,t.__)("Please select a target database engine","wp-dbal"))}})]}),v&&(0,r.jsx)(h,{progress:v}),"completed"===v?.status&&!B&&L&&(0,r.jsx)(b,{targetEngine:L.targetEngine,connectionParams:L.connectionParams,onComplete:e=>{F(e),"manual"===e&&n&&n(e,L)}}),"completed"!==v?.status&&(0,r.jsx)(u,{isMigrating:D,canStart:!!i&&w?.success,onStart:async()=>{if(i)if(w&&w.success){T(null),S(!0),F(null),N({targetEngine:i,connectionParams:c});try{const e=await l()({path:"/wp-dbal/v1/migration/start",method:"POST",data:{target_engine:i,connection_params:c}});e.success?(C(e.session_id),(async e=>{let a=!1,n=0;for(;!a&&n<1e4;){n++;try{const n=await l()({path:"/wp-dbal/v1/migration/chunk",method:"POST",data:{session_id:e}});if(!n.success){T(n.message||(0,t.__)("Chunk processing failed","wp-dbal")),S(!1),a=!0;break}if(y(n.progress),a=n.complete,a){S(!1),"failed"===n.progress.status&&T(n.progress.error||(0,t.__)("Migration failed","wp-dbal"));break}await new Promise(e=>setTimeout(e,100))}catch(e){T(e.message||(0,t.__)("Chunk processing failed","wp-dbal")),S(!1),a=!0;break}}n>=1e4&&(T((0,t.__)("Migration timeout - maximum iterations exceeded","wp-dbal")),S(!1))})(e.session_id)):(T(e.message||(0,t.__)("Failed to start migration","wp-dbal")),S(!1))}catch(e){T(e.message||(0,t.__)("Failed to start migration","wp-dbal")),S(!1)}}else T((0,t.__)("Please validate the connection first","wp-dbal"));else T((0,t.__)("Please select a target database engine","wp-dbal"))},onCancel:async()=>{if(f)try{await l()({path:"/wp-dbal/v1/migration/cancel",method:"POST",data:{session_id:f}}),S(!1),C(null),y(null)}catch(e){console.error("Failed to cancel migration:",e)}},progress:v})]})}function g(){const[e,s]=(0,a.useState)(null),[p,_]=(0,a.useState)(!0),[h,u]=(0,a.useState)(null),[b,g]=(0,a.useState)(!1),[m,w]=(0,a.useState)(null);(0,a.useEffect)(()=>{j()},[]);const j=async()=>{_(!0),u(null);try{const e=await l()({path:"/wp-dbal/v1/admin/status"});e.success?s(e.data):u((0,t.__)("Failed to fetch status","wp-dbal"))}catch(e){u(e.message||(0,t.__)("Failed to fetch status","wp-dbal"))}finally{_(!1)}};return p&&!e?(0,r.jsxs)("div",{className:"wrap",children:[(0,r.jsx)("h1",{children:(0,t.__)("WP-DBAL Settings","wp-dbal")}),(0,r.jsx)("p",{children:(0,t.__)("Loading...","wp-dbal")})]}):(0,r.jsxs)("div",{className:"wrap",children:[(0,r.jsx)("h1",{children:(0,t.__)("WP-DBAL Settings","wp-dbal")}),h&&(0,r.jsx)("div",{className:"notice notice-error",children:(0,r.jsx)("p",{children:h})}),e&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(d,{}),(0,r.jsx)(o,{status:e}),(0,r.jsx)(i,{dropinInstalled:e.dropin_installed,onAction:async e=>{u(null);try{const a="install"===e?"/wp-dbal/v1/admin/dropin/install":"/wp-dbal/v1/admin/dropin/remove",n=await l()({path:a,method:"POST"});n.success?await j():u(n.message||(0,t.__)("Action failed","wp-dbal"))}catch(e){u(e.message||(0,t.__)("Action failed","wp-dbal"))}}}),b&&m&&(0,r.jsx)(c,{targetEngine:m.targetEngine,connectionParams:m.connectionParams}),(0,r.jsxs)(n.Card,{style:{marginTop:"20px"},children:[(0,r.jsx)(n.CardHeader,{children:(0,r.jsx)("h2",{children:(0,t.__)("Database Migration","wp-dbal")})}),(0,r.jsx)(n.CardBody,{children:(0,r.jsx)(x,{currentEngine:e.db_engine,onConfigChoice:(e,a)=>{"manual"===e&&(g(!0),w(a))}})})]})]})]})}function m(){const e=document.getElementById("wp-dbal-admin-root");if(e)try{(0,a.render)((0,r.jsx)(g,{}),e),console.log("WP-DBAL: Admin UI rendered successfully")}catch(e){console.error("WP-DBAL: Error rendering admin UI",e)}else console.warn("WP-DBAL: Admin container not found. Looking for #wp-dbal-admin-root")}"undefined"!=typeof window&&window.wpDbalAdmin?.restNonce&&l().use(l().createNonceMiddleware(window.wpDbalAdmin.restNonce)),"undefined"!=typeof window&&window.wpDbalAdmin?.restNonce&&l().use(l().createNonceMiddleware(window.wpDbalAdmin.restNonce)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m()})();